# SuYan Input Method - GitHub Actions 构建发布
name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  QT_VERSION: '6.5.3'
  LIBRIME_VERSION: '1.16.1'

jobs:
  build-macos:
    name: Build macOS PKG
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          cache: true
      
      - name: Install dependencies
        run: |
          brew install yaml-cpp
      
      - name: Download librime
        run: |
          echo "Downloading librime ${LIBRIME_VERSION}..."
          
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/rime/librime/releases/tags/${LIBRIME_VERSION}")
          
          if echo "${RELEASE_JSON}" | jq -e '.assets' > /dev/null 2>&1; then
            echo "API response OK"
          else
            echo "Error: Failed to get release info"
            echo "${RELEASE_JSON}"
            exit 1
          fi
          
          ASSET_NAME=$(echo "${RELEASE_JSON}" | jq -r '.assets[].name' | grep "macOS-universal.*\.tar\.bz2" | head -1)
          
          if [ -z "${ASSET_NAME}" ]; then
            echo "Error: Could not find macOS universal asset for librime ${LIBRIME_VERSION}"
            echo "Available assets:"
            echo "${RELEASE_JSON}" | jq -r '.assets[].name'
            exit 1
          fi
          
          echo "Found asset: ${ASSET_NAME}"
          
          curl -L -o librime.tar.bz2 \
            "https://github.com/rime/librime/releases/download/${LIBRIME_VERSION}/${ASSET_NAME}"
          
          mkdir -p librime_temp
          tar -xjf librime.tar.bz2 -C librime_temp
          
          echo "Extracted contents:"
          find librime_temp -type f \( -name "*.h" -o -name "*.dylib" \) | head -20
          
          mkdir -p deps/librime/include deps/librime/lib
          
          if [ -d "librime_temp/dist" ]; then
            cp librime_temp/dist/include/*.h deps/librime/include/
            cp librime_temp/dist/lib/librime*.dylib deps/librime/lib/
          else
            find librime_temp -name "*.h" -exec cp {} deps/librime/include/ \;
            find librime_temp -name "librime*.dylib" -exec cp {} deps/librime/lib/ \;
          fi
          
          rm -rf librime_temp librime.tar.bz2
          
          echo "=== Include files ==="
          ls -la deps/librime/include/
          echo "=== Library files ==="
          ls -la deps/librime/lib/
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${Qt6_DIR}/.." \
            -DQt6_DIR="${Qt6_DIR}"
      
      - name: Build
        run: |
          cd build
          cmake --build . --target SuYan -j$(sysctl -n hw.ncpu)
      
      - name: Deploy Qt frameworks
        run: |
          cd build
          cmake --build . --target deploy_qt || {
            echo "deploy_qt target not found, running macdeployqt manually..."
            macdeployqt bin/SuYan.app -verbose=2
          }
      
      - name: Verify bundle
        run: |
          BUNDLE="build/bin/SuYan.app"
          
          echo "Checking bundle structure..."
          test -d "${BUNDLE}" || { echo "Bundle not found"; exit 1; }
          test -f "${BUNDLE}/Contents/MacOS/SuYan" || { echo "Executable not found"; exit 1; }
          test -f "${BUNDLE}/Contents/Info.plist" || { echo "Info.plist not found"; exit 1; }
          test -d "${BUNDLE}/Contents/SharedSupport/rime" || { echo "RIME data not found"; exit 1; }
          test -f "${BUNDLE}/Contents/Frameworks/librime.1.dylib" || { echo "librime not found"; exit 1; }
          
          echo "Bundle verification passed!"
      
      - name: Create PKG installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE="build/bin/SuYan.app"
          OUTPUT_DIR="output"
          PKG_SCRIPTS="scripts/pkg"
          
          mkdir -p "${OUTPUT_DIR}"
          
          INSTALL_ROOT="${OUTPUT_DIR}/install_root"
          mkdir -p "${INSTALL_ROOT}/Library/Input Methods"
          cp -R "${BUNDLE}" "${INSTALL_ROOT}/Library/Input Methods/"
          
          echo "Signing bundle with ad-hoc signature..."
          codesign --force --deep --sign - "${INSTALL_ROOT}/Library/Input Methods/SuYan.app" || true
          
          echo "Creating component package..."
          pkgbuild \
            --root "${INSTALL_ROOT}" \
            --identifier "cn.zhangjh.inputmethod.SuYan" \
            --version "${VERSION}" \
            --install-location "/" \
            --scripts "${PKG_SCRIPTS}" \
            "${OUTPUT_DIR}/SuYan-component.pkg"
          
          cat > "${OUTPUT_DIR}/distribution.xml" << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="2">
              <title>素言输入法</title>
              <organization>cn.zhangjh</organization>
              <domains enable_localSystem="true"/>
              <options customize="never" require-scripts="true" rootVolumeOnly="true"/>
              <welcome file="welcome.html"/>
              <conclusion file="conclusion.html"/>
              <os-version min="13.0"/>
              <choices-outline>
                  <line choice="default">
                      <line choice="cn.zhangjh.inputmethod.SuYan"/>
                  </line>
              </choices-outline>
              <choice id="default"/>
              <choice id="cn.zhangjh.inputmethod.SuYan" visible="false">
                  <pkg-ref id="cn.zhangjh.inputmethod.SuYan"/>
              </choice>
              <pkg-ref id="cn.zhangjh.inputmethod.SuYan" version="${VERSION}" onConclusion="none">SuYan-component.pkg</pkg-ref>
          </installer-gui-script>
          EOF
          
          echo "Creating final PKG..."
          productbuild \
            --distribution "${OUTPUT_DIR}/distribution.xml" \
            --package-path "${OUTPUT_DIR}" \
            --resources "${PKG_SCRIPTS}/resources" \
            "${OUTPUT_DIR}/SuYan-${VERSION}-macos.pkg"
          
          rm -rf "${INSTALL_ROOT}"
          rm -f "${OUTPUT_DIR}/SuYan-component.pkg"
          rm -f "${OUTPUT_DIR}/distribution.xml"
          
          echo "PKG created: ${OUTPUT_DIR}/SuYan-${VERSION}-macos.pkg"
          ls -lh "${OUTPUT_DIR}/"
      
      - name: Build uninstaller
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OUTPUT_DIR="output"
          UNINSTALLER_APP="${OUTPUT_DIR}/SuYan卸载器.app"
          
          mkdir -p "${UNINSTALLER_APP}/Contents/MacOS"
          mkdir -p "${UNINSTALLER_APP}/Contents/Resources"
          
          cat > "${UNINSTALLER_APP}/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>uninstall</string>
              <key>CFBundleIdentifier</key>
              <string>cn.zhangjh.SuYanUninstaller</string>
              <key>CFBundleName</key>
              <string>SuYan卸载器</string>
              <key>CFBundleDisplayName</key>
              <string>素言输入法卸载器</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST
          
          cat > "${UNINSTALLER_APP}/Contents/MacOS/uninstall" << 'SCRIPT'
          #!/bin/bash
          
          if [ ! -d "/Library/Input Methods/SuYan.app" ]; then
              osascript -e 'display dialog "素言输入法未安装或已被卸载。" buttons {"确定"} default button 1 with title "卸载器" with icon caution'
              exit 0
          fi
          
          RESULT=$(osascript -e 'display dialog "确定要卸载素言输入法吗？\n\n卸载后需要注销或重启才能完全生效。" buttons {"取消", "卸载"} default button 1 with title "素言输入法卸载器" with icon caution')
          
          if [[ "$RESULT" != *"卸载"* ]]; then
              exit 0
          fi
          
          osascript << 'APPLESCRIPT'
          do shell script "
          pkill -x SuYan 2>/dev/null || true
          sleep 1
          pkill -9 -x SuYan 2>/dev/null || true
          rm -rf '/Library/Input Methods/SuYan.app'
          pkgutil --forget cn.zhangjh.inputmethod.SuYan 2>/dev/null || true
          " with administrator privileges
          APPLESCRIPT
          
          if [ $? -eq 0 ]; then
              RESULT=$(osascript -e 'display dialog "是否同时删除用户数据（输入习惯、词频等）？\n\n数据位置: ~/Library/Rime" buttons {"保留数据", "删除数据"} default button 1 with title "卸载完成" with icon note')
              
              if [[ "$RESULT" == *"删除数据"* ]]; then
                  rm -rf "${HOME}/Library/Rime"
              fi
              
              osascript -e 'display dialog "素言输入法已成功卸载！\n\n请注销或重启以完成清理。" buttons {"确定"} default button 1 with title "卸载完成" with icon note'
          else
              osascript -e 'display dialog "卸载失败，请重试。" buttons {"确定"} default button 1 with title "错误" with icon stop'
          fi
          SCRIPT
          
          chmod +x "${UNINSTALLER_APP}/Contents/MacOS/uninstall"
          
          cd "${OUTPUT_DIR}"
          zip -r "SuYan-Uninstaller-${VERSION}-macos.zip" "SuYan卸载器.app"
          rm -rf "SuYan卸载器.app"
          
          echo "Uninstaller created"
          ls -lh
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SuYan-${{ steps.version.outputs.version }}-macos
          path: |
            output/SuYan-*.pkg
            output/SuYan-Uninstaller-*.zip
          retention-days: 7

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Building version: $version"
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          cache: true
      
      - name: Cache Windows dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            deps/yaml-cpp
            deps/sqlite3
            deps/librime
          key: windows-deps-yaml0.8.0-sqlite3.45.0-librime${{ env.LIBRIME_VERSION }}
      
      - name: Download and build yaml-cpp
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = "0.8.0"
          $yamlDir = "${{ github.workspace }}\deps\yaml-cpp"
          New-Item -ItemType Directory -Force -Path "$yamlDir" | Out-Null
          
          Invoke-WebRequest -Uri "https://github.com/jbeder/yaml-cpp/archive/refs/tags/$version.zip" -OutFile "yaml-cpp.zip"
          Expand-Archive -Path "yaml-cpp.zip" -DestinationPath "yaml-cpp-temp"
          
          $buildDir = "yaml-cpp-temp\yaml-cpp-$version\build"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null
          
          cmake -G "Visual Studio 17 2022" -A x64 `
            -DYAML_CPP_BUILD_TESTS=OFF `
            -DYAML_CPP_BUILD_TOOLS=OFF `
            -DYAML_BUILD_SHARED_LIBS=ON `
            -DCMAKE_INSTALL_PREFIX="$yamlDir" `
            -S "yaml-cpp-temp\yaml-cpp-$version" -B $buildDir
          
          cmake --build $buildDir --config Release
          cmake --install $buildDir --config Release
          
          Remove-Item -Recurse -Force yaml-cpp.zip, yaml-cpp-temp
          
          Write-Host "yaml-cpp installed to $yamlDir"
      
      - name: Download SQLite3
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          mkdir deps\sqlite3\include
          mkdir deps\sqlite3\lib
          
          curl -L -o sqlite-src.zip https://www.sqlite.org/2024/sqlite-amalgamation-3450000.zip
          tar -xf sqlite-src.zip
          copy sqlite-amalgamation-3450000\sqlite3.h deps\sqlite3\include\
          
          curl -L -o sqlite-dll.zip https://www.sqlite.org/2024/sqlite-dll-win-x64-3450000.zip
          tar -xf sqlite-dll.zip -C deps\sqlite3\lib
          
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cd deps\sqlite3\lib
          lib /def:sqlite3.def /out:sqlite3.lib /machine:x64
          
          cd ..\..\..
          rmdir /s /q sqlite-amalgamation-3450000
          del sqlite-src.zip sqlite-dll.zip
      
      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
      
      - name: Install 7-Zip
        shell: pwsh
        run: |
          choco install 7zip -y
          echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH
      
      - name: Download librime
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $tag = "${{ env.LIBRIME_VERSION }}"
          $apiUrl = "https://api.github.com/repos/rime/librime/releases/tags/$tag"
          
          $depsDir = "deps\librime"
          $lib32Dir = "$depsDir\lib\x86"
          $lib64Dir = "$depsDir\lib\x64"
          $includeDir = "$depsDir\include"
          
          New-Item -ItemType Directory -Force -Path $lib32Dir | Out-Null
          New-Item -ItemType Directory -Force -Path $lib64Dir | Out-Null
          New-Item -ItemType Directory -Force -Path $includeDir | Out-Null
          
          Write-Host "Fetching release info..."
          $response = Invoke-RestMethod -Uri $apiUrl -Headers @{ Accept = "application/vnd.github.v3+json" }
          Write-Host "Release: $($response.tag_name)"
          
          $patternX86 = "rime-[0-9a-fA-F]+-Windows-msvc-x86\.7z"
          $patternX64 = "rime-[0-9a-fA-F]+-Windows-msvc-x64\.7z"
          
          $downloads = @()
          foreach ($asset in $response.assets) {
              $name = $asset.name
              if ($name -match $patternX86 -and $name -notmatch "deps") {
                  $downloads += @{ url = $asset.browser_download_url; name = $name; type = "x86" }
              }
              elseif ($name -match $patternX64 -and $name -notmatch "deps") {
                  $downloads += @{ url = $asset.browser_download_url; name = $name; type = "x64" }
              }
          }
          
          if ($downloads.Count -lt 2) {
              Write-Host "Error: Could not find both x86 and x64 releases" -ForegroundColor Red
              exit 1
          }
          
          $tempDir = "rime-download"
          New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
          
          foreach ($dl in $downloads) {
              $outFile = "$tempDir\$($dl.name)"
              $extractDir = "$tempDir\$($dl.name -replace '\.7z', '')"
              
              Write-Host "Downloading $($dl.name)..."
              Invoke-WebRequest -Uri $dl.url -OutFile $outFile
              
              Write-Host "Extracting..."
              7z x $outFile -o"$extractDir" -y | Out-Null
              
              $distDir = "$extractDir\dist"
              $targetLibDir = if ($dl.type -eq "x86") { $lib32Dir } else { $lib64Dir }
              
              Copy-Item "$distDir\lib\rime.dll" $targetLibDir -Force
              Copy-Item "$distDir\lib\rime.lib" $targetLibDir -Force
              if (Test-Path "$distDir\lib\rime.pdb") {
                  Copy-Item "$distDir\lib\rime.pdb" $targetLibDir -Force
              }
              
              if ($dl.type -eq "x64") {
                  Copy-Item "$distDir\include\rime_*.h" $includeDir -Force
              }
              
              Write-Host "$($dl.type) libraries copied" -ForegroundColor Green
          }
          
          Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host "librime downloaded successfully"
      
      - name: Configure and Build x64
        shell: pwsh
        run: |
          $buildDir = "build-win"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null
          
          $sqliteDir = "${{ github.workspace }}\deps\sqlite3"
          $yamlDir = "${{ github.workspace }}\deps\yaml-cpp"
          $qtDir = "${{ env.QT_ROOT_DIR }}\lib\cmake\Qt6"
          
          cmake -G "Visual Studio 17 2022" -A x64 `
            -DQt6_DIR="$qtDir" `
            -DSQLite3_INCLUDE_DIR="$sqliteDir\include" `
            -DSQLite3_LIBRARY="$sqliteDir\lib\sqlite3.lib" `
            -Dyaml-cpp_DIR="$yamlDir\lib\cmake\yaml-cpp" `
            -S . -B $buildDir
          
          cmake --build $buildDir --config Release
      
      - name: Configure and Build x86 (TSF client only)
        shell: pwsh
        run: |
          $buildDir = "build-win-x86"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null
          
          cmake -G "Visual Studio 17 2022" -A Win32 -S . -B $buildDir
          
          cmake --build $buildDir --config Release --target SuYanTSFClient
      
      - name: Copy 32-bit DLL
        shell: pwsh
        run: |
          Copy-Item "build-win-x86\src\platform\windows\tsf_client\Release\SuYan32.dll" `
            "build-win\bin\Release\" -Force
      
      - name: Copy dependency DLLs
        shell: pwsh
        run: |
          $releaseDir = "build-win\bin\Release"
          Copy-Item "deps\yaml-cpp\bin\yaml-cpp.dll" $releaseDir -Force
          Copy-Item "deps\sqlite3\lib\sqlite3.dll" $releaseDir -Force
      
      - name: Deploy Qt dependencies
        shell: pwsh
        run: |
          $qtRoot = "${{ env.QT_ROOT_DIR }}"
          $qtBinDir = Join-Path $qtRoot "bin"
          $env:PATH = "$qtBinDir;$env:PATH"
          
          windeployqt --release --no-translations "build-win\bin\Release\SuYanServer.exe"
      
      - name: Update NSIS version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $nsiFile = "installer\suyan.nsi"
          $content = Get-Content $nsiFile -Raw
          $content = $content -replace '!define PRODUCT_VERSION ".*"', "!define PRODUCT_VERSION `"$version`""
          Set-Content $nsiFile $content
      
      - name: Build installer
        shell: pwsh
        working-directory: installer
        run: |
          makensis suyan.nsi
      
      - name: Rename installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          Move-Item "installer\SuYan-$version-Setup.exe" "installer\SuYan-$version-windows.exe"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SuYan-${{ steps.version.outputs.version }}-windows
          path: installer/SuYan-*-windows.exe
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version and release notes
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # 从 tag message 提取 release notes（跳过第一行标题）
          NOTES=$(git tag -l --format='%(contents:body)' "v${VERSION}" | sed '/^$/d')
          if [ -z "$NOTES" ] || [ "$NOTES" = "更新内容待补充" ]; then
            NOTES="暂无更新说明"
          fi
          
          # 处理多行内容
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: SuYan-${{ steps.version.outputs.version }}-macos
          path: artifacts/macos
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: SuYan-${{ steps.version.outputs.version }}-windows
          path: artifacts/windows
      
      - name: List artifacts
        run: |
          echo "=== macOS artifacts ==="
          ls -la artifacts/macos/
          echo "=== Windows artifacts ==="
          ls -la artifacts/windows/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            artifacts/macos/*
            artifacts/windows/*
          name: SuYan v${{ steps.version.outputs.version }}
          body: |
            ## 素言输入法 v${{ steps.version.outputs.version }}
            
            ### 更新内容
            ${{ steps.version.outputs.notes }}
            
            ---
            
            ### 下载
            
            | 平台 | 文件 | 说明 |
            |------|------|------|
            | macOS | `SuYan-${{ steps.version.outputs.version }}-macos.pkg` | 安装包 |
            | macOS | `SuYan-Uninstaller-${{ steps.version.outputs.version }}-macos.zip` | 卸载器 |
            | Windows | `SuYan-${{ steps.version.outputs.version }}-windows.exe` | 安装程序 |
            
            ### 系统要求
            - macOS 13.0 (Ventura) 或更高版本
            - Windows 10 64位 或更高版本
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
